<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper plugin-docs plugin-id-lab docs-version-current docs-doc-page docs-doc-id-lab05/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Lab 5: SPI (Serial Peripheral Interface) | Microprocessor Architecture</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://upb-fils-am-fr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://upb-fils-am-fr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://upb-fils-am-fr.github.io/lab/lab05"><meta data-rh="true" property="og:locale" content="en_GB"><meta data-rh="true" property="og:locale:alternate" content="fr"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-lab-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-lab-current"><meta data-rh="true" property="og:title" content="Lab 5: SPI (Serial Peripheral Interface) | Microprocessor Architecture"><meta data-rh="true" name="description" content="1. Introduction"><meta data-rh="true" property="og:description" content="1. Introduction"><link data-rh="true" rel="icon" href="/img/sigla_am.ico"><link data-rh="true" rel="canonical" href="https://upb-fils-am-fr.github.io/lab/lab05"><link data-rh="true" rel="alternate" href="https://upb-fils-am-fr.github.io/lab/lab05" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://upb-fils-am-fr.github.io/fr/lab/lab05" hreflang="fr"><link data-rh="true" rel="alternate" href="https://upb-fils-am-fr.github.io/lab/lab05" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f442cfaf.css">
<script src="/assets/js/runtime~main.6d121175.js" defer="defer"></script>
<script src="/assets/js/main.b9382a7a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/sigla_am.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sigla_am.svg" alt="Microprocessor Architecture" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sigla_am.svg" alt="Microprocessor Architecture" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Microprocessor Architecture</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/lab">Lab</a><a class="navbar__item navbar__link" href="/project">Project</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/lab/lab05" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-GB">English</a></li><li><a href="/fr/lab/lab05" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Fran√ßais</a></li></ul></div><a href="https://github.com/UPB-FILS-AM-FR/am-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab">General Lab Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab00">Laboratory 0: Introductory Applications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab01">Laboratory 1: USART. Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab02">Laboratory 2: Interrupts, Timers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab03">Lab 3: Timers, Pulse Width Modulation (PWM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab04">Lab 4: Analog to Digital Converter (ADC)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/lab/lab05">Lab 5: SPI (Serial Peripheral Interface)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lab/lab06">Lab 6: I2C (Inter-Integrated Circuit)</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 5: SPI (Serial Peripheral Interface)</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Lab 5: SPI (Serial Peripheral Interface)</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-introduction">1. Introduction<a href="#1-introduction" class="hash-link" aria-label="Direct link to 1. Introduction" title="Direct link to 1. Introduction">‚Äã</a></h2>
<p>In this lab, we‚Äôll explore the SPI communication protocol, widely used in embedded systems for data exchange between two or more devices. The final objective will be to build an audio player on the lab board that reads <em>.wav</em> files from an SD card and plays them using the onboard speaker.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-spi-protocol-serial-peripheral-interface">2. SPI Protocol (Serial Peripheral Interface)<a href="#2-spi-protocol-serial-peripheral-interface" class="hash-link" aria-label="Direct link to 2. SPI Protocol (Serial Peripheral Interface)" title="Direct link to 2. SPI Protocol (Serial Peripheral Interface)">‚Äã</a></h2>
<p>SPI is a synchronous communication standard developed by Motorola. It operates in full-duplex mode (data transfer happens simultaneously in both directions).</p>
<p>Communication is based on a <strong>Master-Slave</strong> architecture (one Master device and one or more Slaves). The <strong>Master</strong> always initiates communication.</p>
<p>SPI is also known as a <em>four-wire</em> protocol due to its use of four separate lines:</p>
<ul>
<li><strong>MOSI</strong> ‚Äî Master Out Slave In (data from <strong>Master</strong> to <strong>Slave</strong>)</li>
<li><strong>MISO</strong> ‚Äî Master In Slave Out (data from <strong>Slave</strong> to <strong>Master</strong>)</li>
<li><strong>SCLK</strong> ‚Äî Serial Clock (clock signal generated by the <strong>Master</strong>)</li>
<li><strong>CS / SS</strong> ‚Äî Chip Select / Slave Select (used by the <strong>Master</strong> to select the <strong>Slave</strong>; active LOW)</li>
</ul>
<p><img decoding="async" loading="lazy" alt="SPI Bus Diagram" src="/assets/images/spi1-c07b5ddb264b81bc8bc6a76035479843.png" width="616" height="180" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-connecting-multiple-slaves">2.1 Connecting Multiple Slaves<a href="#21-connecting-multiple-slaves" class="hash-link" aria-label="Direct link to 2.1 Connecting Multiple Slaves" title="Direct link to 2.1 Connecting Multiple Slaves">‚Äã</a></h3>
<p>Multiple <strong>Slave</strong> devices can be connected to a single <strong>Master</strong>. The <em>MOSI</em>, <em>MISO</em>, and <em>SCLK</em> lines are shared, while each <strong>Slave</strong> has a separate <em>CS / SS</em> line.</p>
<p>When the <strong>Master</strong> wants to communicate with a particular <strong>Slave</strong>, it sets the corresponding <em>CS / SS</em> line to <strong>LOW</strong> (active). All other <em>SS</em> lines remain <strong>HIGH</strong>, and those <strong>Slaves</strong> ignore communication.</p>
<p><img decoding="async" loading="lazy" alt="Multiple Slaves Setup" src="/assets/images/spi2-7f31c92edc5bed207da18df7e6987082.png" width="483" height="382" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-data-transmission-in-spi">3. Data Transmission in SPI<a href="#3-data-transmission-in-spi" class="hash-link" aria-label="Direct link to 3. Data Transmission in SPI" title="Direct link to 3. Data Transmission in SPI">‚Äã</a></h2>
<p>To begin communication:</p>
<ol>
<li>The <strong>Master</strong> sets the clock frequency (must not exceed the <strong>Slave</strong>&#x27;s max supported rate).</li>
<li>It selects the <strong>Slave</strong> by setting its <em>CS / SS</em> line LOW.</li>
</ol>
<p>During each SPI clock cycle (full-duplex):</p>
<ul>
<li>The <strong>Master</strong> sends a bit via <em>MOSI</em>, and the <strong>Slave</strong> reads it.</li>
<li>The <strong>Slave</strong> simultaneously sends a bit via <em>MISO</em>, which the <strong>Master</strong> reads.</li>
</ul>
<p>This is usually done through circularly connected <strong>shift registers</strong> in both <strong>Master</strong> and <strong>Slave</strong>.</p>
<p><img decoding="async" loading="lazy" alt="SPI Shift Register" src="/assets/images/spi4-d7fa83e3592c2264abca5adbf7cf92f7.png" width="629" height="200" class="img_ev3q"></p>
<p>Typically:</p>
<ul>
<li>The most significant bit (MSB) is sent first.</li>
<li>After one word is transmitted, both devices will have exchanged the entire contents of their shift registers.</li>
</ul>
<p>Once data transmission is complete:</p>
<ul>
<li>The <strong>Master</strong> stops the clock signal (<em>SCLK</em>).</li>
<li>It deactivates the <strong>Slave</strong> by setting the associated <em>CS / SS</em> line to <strong>HIGH</strong>.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Full SPI Transaction" src="/assets/images/spi5-9f60a370016b7b09f537ec7f41ae49ac.png" width="650" height="478" class="img_ev3q"></p>
<p><strong>Note</strong>: All unselected <strong>Slaves</strong> ignore clock and <em>MOSI</em> lines and don‚Äôt drive the <em>MISO</em> line.
Only one <strong>Slave</strong> can be selected at a time by the <strong>Master</strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-spi-on-atmega324">4. SPI on ATMega324<a href="#4-spi-on-atmega324" class="hash-link" aria-label="Direct link to 4. SPI on ATMega324" title="Direct link to 4. SPI on ATMega324">‚Äã</a></h2>
<p>The ATMega324 microcontroller provides users with an SPI interface that can operate in both <strong>Master</strong> and <strong>Slave</strong> modes.</p>
<p>As usual, configuring and using this interface involves working with control, status, and data registers.</p>
<p>The full description of the SPI-related registers can be found in the <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-42743-ATmega324P_Datasheet.pdf" target="_blank" rel="noopener noreferrer">ATmega324P Datasheet</a>, Chapter: <strong>SPI ‚Äì Serial Peripheral Interface</strong> (starting on page 214).</p>
<p>Below is a brief overview of the most important SPI registers and fields:</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi-control-register-spcr">SPI Control Register (SPCR)<a href="#spi-control-register-spcr" class="hash-link" aria-label="Direct link to SPI Control Register (SPCR)" title="Direct link to SPI Control Register (SPCR)">‚Äã</a></h3>
<table><thead><tr><th>Bit</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>6</td><td><strong>SPE</strong></td><td>SPI Enable ‚Äî Set to 1 to enable the SPI interface</td></tr><tr><td>5</td><td><strong>DORD</strong></td><td>Data Order ‚Äî 1: LSB transmitted first, 0: MSB first</td></tr><tr><td>4</td><td><strong>MSTR</strong></td><td>Master/Slave Select ‚Äî 1: Master mode, 0: Slave mode</td></tr><tr><td>3-0</td><td><strong>CPOL, CPHA, SPR1, SPR0</strong></td><td>Clock polarity, phase, and frequency selection</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="SPCR Register" src="/assets/images/spcr-8f6fca8802214feb9fb67b1b7b4a847b.png" width="945" height="134" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi-status-register-spsr">SPI Status Register (SPSR)<a href="#spi-status-register-spsr" class="hash-link" aria-label="Direct link to SPI Status Register (SPSR)" title="Direct link to SPI Status Register (SPSR)">‚Äã</a></h3>
<table><thead><tr><th>Bit</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>7</td><td><strong>SPIF</strong></td><td>SPI Interrupt Flag ‚Äî Set to 1 when a transfer is complete</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="SPSR Register" src="/assets/images/spsr-7044f2fd163694646c948fe7326d5417.png" width="947" height="127" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi-data-register-spdr">SPI Data Register (SPDR)<a href="#spi-data-register-spdr" class="hash-link" aria-label="Direct link to SPI Data Register (SPDR)" title="Direct link to SPI Data Register (SPDR)">‚Äã</a></h3>
<p>The <strong>SPDR</strong> register is used to both transmit and receive data:</p>
<ul>
<li>Writing to this register <strong>starts a new transmission</strong> (in <strong>Master</strong> mode).</li>
<li>Reading from it gives you the data received via SPI.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="SPDR Register" src="/assets/images/spdr-44e02aba316de9a2121a6a4e50c601c7.png" width="958" height="127" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-fat-sd-card">5. FAT SD Card<a href="#5-fat-sd-card" class="hash-link" aria-label="Direct link to 5. FAT SD Card" title="Direct link to 5. FAT SD Card">‚Äã</a></h2>
<p>The lab board includes an SD card reader that communicates with the ATMega324 microcontroller via the SPI protocol ‚Äî which is the main use case for today‚Äôs lab.</p>
<p>The diagram below shows how the SD card reader is connected to the microcontroller. Notice that some of the pins we&#x27;ve already used in past labs are reused here for SPI signals.</p>
<p><img decoding="async" loading="lazy" alt="SD Card SPI Connection" src="data:image/png;base64,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995885P338/JuHz8q+dfdf/moYPr/+HSL/532xdKi/jj78L1e2/c2H/t/87fczDpXb//8d+99OPEWBw8/PgX/sdf/tdHrk3M081/+98XPrxRalG+897EO6n3fvjg4cceegypy1rrXeYldbqbqvofb95cIrp64YJIIsnRyPiP/kZ89NENWfTMnPUUd9npP+/bRz/9/sRPU9y1Yun39OvxyK/HV/q8vrzvvQ+/f2cn61oPSR76h2/8A1JHlL3WuwxL6nQ3VfVEf53F5cpdf923CXajolg5yFbrXcYldSrIqjogdXefuSy13qVqpbM2VPCeji7X5Gw0lthPV9tAcF2+xBpbp10bcnYMTHN4TcEeOMLMVutdpiX1jYWaYquqQ86gv27HbKO/DjDXFayia70DpG7XK7rWOygsOPsZAKkDQOoAAKkDQOoAAKkDQOoAAKkDQOoAkDoAQOoAkDoAQOoAkDoAQOoAkDoApA4AkDoApA4AkDoApA4AkDoApA4Aqdsllm7dwv8D9oL9ioqKXfJUPqVU3vfAA/iXQPGn7q/8fowCAD7XASB1AIDUASB1AIDUASB1AIDUASB1AEgdACB1AEgdACB1AEgdAGy0f35iAqOwIz58910Mwh5N3SvV1RiFHVRSUoJB2HOp+5bXi1HYETfj8Y9++9sH1GoMxZ57q11aWsIoAOQTqikASB0AUgcASB0AUgcASB0AUgcASB0AUgeA1AEAUgeA1AEAUgeA1AEAUgeA1AEgdQCQe/8fGGm7L8PjFOcAAAAASUVORK5CYII=" width="295" height="308" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sd-card-format-fat32">SD Card Format: FAT32<a href="#sd-card-format-fat32" class="hash-link" aria-label="Direct link to SD Card Format: FAT32" title="Direct link to SD Card Format: FAT32">‚Äã</a></h3>
<p>The SD cards we&#x27;ll be working with are formatted using the <strong>FAT32</strong> file system. To simplify file operations, we‚Äôll use the <strong>Petit FAT Filesystem</strong> library ‚Äî chosen for its small footprint (2‚Äì4 KB) and minimal RAM usage (just 46 bytes plus stack).</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="petit-fat-filesystem-api">Petit FAT Filesystem API<a href="#petit-fat-filesystem-api" class="hash-link" aria-label="Direct link to Petit FAT Filesystem API" title="Direct link to Petit FAT Filesystem API">‚Äã</a></h3>
<p>Here are the main functions provided by the library:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_mount</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FATFS</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// Mount or unmount a volume</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_open</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// Open a file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_read</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> WORD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> WORD</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Read data from a file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_write</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> WORD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> WORD</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Write data to a file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_lseek</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DWORD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// Move file pointer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_opendir</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DIR</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Open a directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FRESULT </span><span class="token function" style="color:#d73a49">pf_readdir</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DIR</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FILINFO</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// Read from a directory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These functions allow low-level file access from an embedded system ‚Äî exactly what we need to implement a basic audio player on our microcontroller board.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-exercises">6. Exercises<a href="#6-exercises" class="hash-link" aria-label="Direct link to 6. Exercises" title="Direct link to 6. Exercises">‚Äã</a></h2>
<p>üì• <strong>Download the starter code archive:</strong><br>
<a href="https://ocw.cs.pub.ro/courses/_media/pm/lab/lab5_skel.zip" target="_blank" rel="noopener noreferrer">lab5_skel.zip</a></p>
<p>In this lab, you won‚Äôt be writing a lot of code, but it‚Äôs important to understand how your code interacts with the skeleton and the behavior of the library functions you‚Äôll use.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-spi-control">Task 1: SPI Control<a href="#task-1-spi-control" class="hash-link" aria-label="Direct link to Task 1: SPI Control" title="Direct link to Task 1: SPI Control">‚Äã</a></h3>
<p>Implement the basic SPI communication functions in <code>spi.c</code>:</p>
<ul>
<li><code>SPI_init()</code></li>
<li><code>SPI_exchange()</code></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><ul>
<li>Configure <strong>PB4 (SS)</strong> as output and set it to <strong>HIGH</strong> to disable SPI interrupt triggering via slave select.</li>
<li>Follow examples from <strong>page 217</strong> of the datasheet.</li>
<li>Refer to section 5&#x27;s wiring diagram to identify <strong>MOSI</strong> and <strong>SCLK</strong> pins.</li>
<li>Set SPI to <strong>Master</strong> mode with <strong>SCLK = fosc/16</strong> (slower frequency for SD card compatibility).</li>
<li>Remember to use register names with a <code>0</code> suffix: <code>SPCR0</code>, <code>SPDR0</code>, etc.</li>
<li>Use <code>SPDR0</code> to send data and receive the response in one function (full-duplex), replacing the need for <code>SPI_read()</code> and <code>SPI_write()</code>.</li>
</ul></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-2-sd-card-control">Task 2: SD Card Control<a href="#task-2-sd-card-control" class="hash-link" aria-label="Direct link to Task 2: SD Card Control" title="Direct link to Task 2: SD Card Control">‚Äã</a></h3>
<p>In <code>sd.c</code>, implement:</p>
<ul>
<li><code>SD_init()</code></li>
<li><code>SD_receive()</code></li>
<li><code>SD_transmit()</code></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><ul>
<li><strong>PA2</strong> (SS for SD card) must be set as output. Leave the HIGH/LOW handling to the skeleton code.</li>
<li>Use <code>SPI_exchange()</code> for both transmitting and receiving.</li>
<li>In <code>SD_receive()</code>, send <strong>0xFF</strong> as a dummy byte to initiate a read (Master must always initiate).</li>
<li>‚úÖ <strong>Checkpoint:</strong> After flashing your code, the LCD should change from <code>Mounting...</code> to <code>Mounted!</code>. If not, hit the <strong>RESET</strong> button and debug if needed.</li>
</ul></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-3-first-file-display">Task 3: First File Display<a href="#task-3-first-file-display" class="hash-link" aria-label="Direct link to Task 3: First File Display" title="Direct link to Task 3: First File Display">‚Äã</a></h3>
<p>Implement <code>init_directory()</code> in <code>lab5.c</code> to show the first <code>.wav</code> file from the <code>/music</code> directory:</p>
<ul>
<li>Use <code>pf_opendir()</code> to open the directory.</li>
<li>Use <code>pf_readdir()</code> to iterate through entries.</li>
<li>Skip files starting with an underscore <code>_</code>.</li>
<li>Use <code>LCD_clear_top_line()</code> and <code>LCD_printAt()</code> to display the file name.</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-4-file-cycling">Task 4: File Cycling<a href="#task-4-file-cycling" class="hash-link" aria-label="Direct link to Task 4: File Cycling" title="Direct link to Task 4: File Cycling">‚Äã</a></h3>
<p>In <code>lab5.c</code>, handle button <strong>PB2</strong>:</p>
<ul>
<li>On press, show the <strong>next valid file</strong> from <code>/music</code> (skip names starting with <code>_</code>).</li>
<li>If at the last file, wrap around to the <strong>first</strong> file.</li>
<li><code>pf_readdir()</code> returns a file with name <code>&quot;&quot;</code> (empty string) at the end of the directory.</li>
<li>Add a <strong>delay (200‚Äì300ms)</strong> to avoid multiple file changes on a single button press.</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-5-play-music-">Task 5: Play Music üéµ<a href="#task-5-play-music-" class="hash-link" aria-label="Direct link to Task 5: Play Music üéµ" title="Direct link to Task 5: Play Music üéµ">‚Äã</a></h3>
<p>When <strong>PD6</strong> is pressed, call <code>play()</code> to play the currently displayed file:</p>
<ul>
<li>Implement the behavior in the <code>TODO5</code> section of <code>lab5.c</code>.</li>
<li>Playback can be <strong>interrupted</strong> by pressing <strong>PD6 + PB2</strong> together ‚Äî this is already handled in the skeleton.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-useful-links">üîó Useful Links<a href="#-useful-links" class="hash-link" aria-label="Direct link to üîó Useful Links" title="Direct link to üîó Useful Links">‚Äã</a></h2>
<ul>
<li>üìò <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-42743-ATmega324P_Datasheet.pdf" target="_blank" rel="noopener noreferrer">ATmega324P Datasheet</a></li>
<li>üíæ <a href="https://codeandlife.com/2012/04/25/simple-fat-and-sd-tutorial-part-3/" target="_blank" rel="noopener noreferrer">FAT SD Card Tutorial</a></li>
<li>üîÑ <a href="https://learn.sparkfun.com/tutorials/serial-peripheral-interface-spi/all" target="_blank" rel="noopener noreferrer">SPI Protocol Guide</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/lab/lab04"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab 4: Analog to Digital Converter (ADC)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/lab/lab06"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab 6: I2C (Inter-Integrated Circuit)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-introduction" class="table-of-contents__link toc-highlight">1. Introduction</a></li><li><a href="#2-spi-protocol-serial-peripheral-interface" class="table-of-contents__link toc-highlight">2. SPI Protocol (Serial Peripheral Interface)</a><ul><li><a href="#21-connecting-multiple-slaves" class="table-of-contents__link toc-highlight">2.1 Connecting Multiple Slaves</a></li></ul></li><li><a href="#3-data-transmission-in-spi" class="table-of-contents__link toc-highlight">3. Data Transmission in SPI</a></li><li><a href="#4-spi-on-atmega324" class="table-of-contents__link toc-highlight">4. SPI on ATMega324</a><ul><li><a href="#spi-control-register-spcr" class="table-of-contents__link toc-highlight">SPI Control Register (SPCR)</a></li><li><a href="#spi-status-register-spsr" class="table-of-contents__link toc-highlight">SPI Status Register (SPSR)</a></li><li><a href="#spi-data-register-spdr" class="table-of-contents__link toc-highlight">SPI Data Register (SPDR)</a></li></ul></li><li><a href="#5-fat-sd-card" class="table-of-contents__link toc-highlight">5. FAT SD Card</a><ul><li><a href="#sd-card-format-fat32" class="table-of-contents__link toc-highlight">SD Card Format: FAT32</a></li><li><a href="#petit-fat-filesystem-api" class="table-of-contents__link toc-highlight">Petit FAT Filesystem API</a></li></ul></li><li><a href="#6-exercises" class="table-of-contents__link toc-highlight">6. Exercises</a><ul><li><a href="#task-1-spi-control" class="table-of-contents__link toc-highlight">Task 1: SPI Control</a></li><li><a href="#task-2-sd-card-control" class="table-of-contents__link toc-highlight">Task 2: SD Card Control</a></li><li><a href="#task-3-first-file-display" class="table-of-contents__link toc-highlight">Task 3: First File Display</a></li><li><a href="#task-4-file-cycling" class="table-of-contents__link toc-highlight">Task 4: File Cycling</a></li><li><a href="#task-5-play-music-" class="table-of-contents__link toc-highlight">Task 5: Play Music üéµ</a></li></ul></li><li><a href="#-useful-links" class="table-of-contents__link toc-highlight">üîó Useful Links</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/pm" target="_blank" rel="noopener noreferrer" class="footer__link-item">UPB Open CourseWare <svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2025 Politehnica Bucharest. <br> This pages are the translated and adapted version from https://ocw.cs.pub.ro/courses/pm</div></div></div></footer></div>
</body>
</html>